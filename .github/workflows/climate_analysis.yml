name: Climate Analysis

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      analysis_type:
        description: 'Analysis type'
        required: true
        default: 'baseline'
        type: choice
        options:
          - baseline
          - heatwave
          - extreme
      quick_mode:
        description: 'Run in quick mode'
        required: true
        default: 'true'
        type: boolean

jobs:
  analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-dev
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        echo "Installed packages:"
        pip list
    
    - name: Verify installation
      run: |
        python -c "import numpy; print(f'NumPy: {numpy.__version__}')"
        python -c "import scipy; print(f'SciPy: {scipy.__version__}')"
        python -c "import matplotlib; print(f'Matplotlib: {matplotlib.__version__}')"
        python -c "import networkx; print(f'NetworkX: {networkx.__version__}')"
    
    - name: Check directory structure
      run: |
        echo "Current directory: $(pwd)"
        echo "Directory contents:"
        ls -la
        echo "Models directory:"
        ls -la models/ || echo "No models directory"
        echo "Analysis directory:"
        ls -la analysis/ || echo "No analysis directory"
        echo "Utils directory:"
        ls -la utils/ || echo "No utils directory"
    
    - name: Run analysis
      env:
        PYTHONPATH: ${{ github.workspace }}
        MPLBACKEND: Agg
      run: |
        # Use workflow inputs if available, otherwise defaults
        ANALYSIS_TYPE="${{ github.event.inputs.analysis_type || 'baseline' }}"
        QUICK_MODE="${{ github.event.inputs.quick_mode || 'true' }}"
        
        echo "Running analysis: type=$ANALYSIS_TYPE, quick=$QUICK_MODE"
        
        if [ "$QUICK_MODE" = "true" ]; then
          python main.py --analysis-type $ANALYSIS_TYPE --quick-mode --output-dir results
        else
          python main.py --analysis-type $ANALYSIS_TYPE --output-dir results
        fi
    
    - name: Check results
      if: always()
      run: |
        echo "Results directory contents:"
        if [ -d results ]; then
          ls -la results/
          echo "PNG files:"
          find results -name "*.png" -type f | wc -l
          echo "Data files:"
          find results -name "*.npz" -type f | wc -l
        else
          echo "No results directory found"
        fi
    
    - name: Upload results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: analysis-results-${{ github.run_number }}
        path: results/
        retention-days: 30
    
    - name: Upload logs
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: error-logs-${{ github.run_number }}
        path: |
          *.log
          results/*.txt
